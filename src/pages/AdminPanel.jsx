import React,{useState} from 'react';
import VehicleCard from '../components/VehicleCard';
import { loadJSON, saveJSON } from '../utils/storage';
import { EMAILJS_KEY, ADMIN_PASS_KEY } from '../utils/constants';
import { sha256Hex } from '../utils/hash';
export default function AdminPanel({vehicles,setVehicles,onLogout}){
  const [newV,setNewV]=useState({name:'',price:'',vendor:'',image:''});
  const [cfg,setCfg]=useState(()=> loadJSON(EMAILJS_KEY,{serviceId:'service_e17hvxl',templateCustomer:'template_kamg5at',templateAdmin:'template_ioh29kj',publicKey:'QPwqVGA4_6NO2Wo6_'}));
  const [newPass,setNewPass]=useState('');
  const handleAdd=()=>{ if(!newV.name||!newV.price||!newV.vendor||!newV.image){ alert('Fill all'); return;} setVehicles(p=>[...p,{id:Date.now(),...newV}]); setNewV({name:'',price:'',vendor:'',image:''}); };
  const saveCfg=()=>{ saveJSON(EMAILJS_KEY,cfg); alert('EmailJS settings saved'); };
  const changePass=async()=>{ if(!newPass){ alert('Enter new'); return;} const h=await sha256Hex(newPass); localStorage.setItem(ADMIN_PASS_KEY,h); alert('Password updated! Please login again.'); onLogout(); };
  return (<section style={{padding:28}}><div style={{display:'flex',justifyContent:'space-between'}}><h2>Admin Panel</h2><div><button className='btn btn-yellow' onClick={()=>{ onLogout();}}>Logout</button></div></div><div className='card' style={{marginTop:12}}><h3>Add Vehicle</h3><input placeholder='Vehicle name' value={newV.name} onChange={e=>setNewV(p=>({...p,name:e.target.value}))} className='form-input'/><input placeholder='Rent' value={newV.price} onChange={e=>setNewV(p=>({...p,price:e.target.value}))} className='form-input'/><input placeholder='Vendor' value={newV.vendor} onChange={e=>setNewV(p=>({...p,vendor:e.target.value}))} className='form-input'/><input type='file' onChange={e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onloadend=()=>setNewV(p=>({...p,image:r.result})); r.readAsDataURL(f); }} className='form-input'/><button className='btn btn-blue' onClick={handleAdd}>Add Vehicle</button></div><div className='card' style={{marginTop:12}}><h3>EmailJS Configuration</h3><input placeholder='Service ID' value={cfg.serviceId} onChange={e=>setCfg(p=>({...p,serviceId:e.target.value}))} className='form-input'/><input placeholder='Template Customer' value={cfg.templateCustomer} onChange={e=>setCfg(p=>({...p,templateCustomer:e.target.value}))} className='form-input'/><input placeholder='Template Admin' value={cfg.templateAdmin} onChange={e=>setCfg(p=>({...p,templateAdmin:e.target.value}))} className='form-input'/><input placeholder='Public Key' value={cfg.publicKey} onChange={e=>setCfg(p=>({...p,publicKey:e.target.value}))} className='form-input'/><button className='btn btn-yellow' onClick={saveCfg}>Save EmailJS Settings</button></div><div className='card' style={{marginTop:12}}><h3>All Vehicles</h3><div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(220px,1fr))',gap:12,marginTop:8}}>{vehicles.map(v=> <div key={v.id}><VehicleCard v={v} isAdmin={true} onVendorChange={(id,val)=>setVehicles(prev=>prev.map(x=>x.id===id?{...x,vendor:val}:x))} /><div style={{display:'flex',gap:8,justifyContent:'center',marginTop:8}}><button className='btn' onClick={()=>setVehicles(prev=>prev.filter(x=>x.id!==v.id))} style={{background:'#ef4444',color:'white'}}>Remove</button></div></div>)}</div></div><div className='card' style={{marginTop:12}}><h3>Change Admin Password</h3><input placeholder='New password' value={newPass} onChange={e=>setNewPass(e.target.value)} className='form-input'/><button className='btn btn-blue' onClick={changePass}>Change Password</button></div><div style={{marginTop:16,textAlign:'center'}}><button className='btn btn-blue' onClick={async()=>{ alert('Deployment started...'); try{ const res=await fetch('http://localhost:3000/deploy',{method:'POST'}); if(res.ok){ alert('✅ Deployment completed successfully!\nhttps://drabienterprises-netizen.github.io/abi-enterprises'); } else alert('⚠️ Deployment failed.'); }catch(e){ alert('⚠️ Deployment failed.'); } }}>🚀 Deploy Site to GitHub Pages</button></div></section>);}